<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"kccarlos.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.13.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="This article discusses  Solutions to Google’s XSS game Re-implementation and patching code in Python Flask, HTML&#x2F;CSS and JavaScript Some thoughts on using Content Security Policy to defense the">
<meta property="og:type" content="article">
<meta property="og:title" content="Cracking and Patching the Google XSS Game">
<meta property="og:url" content="https://kccarlos.github.io/2022/10/15/Cracking-and-Patching-the-Google-XSS-Game/index.html">
<meta property="og:site_name" content="KC Blog">
<meta property="og:description" content="This article discusses  Solutions to Google’s XSS game Re-implementation and patching code in Python Flask, HTML&#x2F;CSS and JavaScript Some thoughts on using Content Security Policy to defense the">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://kccarlos.github.io/uploads/xss.png">
<meta property="og:image" content="https://kccarlos.github.io/uploads/package_capturing.png">
<meta property="article:published_time" content="2022-10-15T19:25:07.000Z">
<meta property="article:modified_time" content="2022-11-07T03:07:00.646Z">
<meta property="article:author" content="kccarlos">
<meta property="article:tag" content="XSS">
<meta property="article:tag" content="Hacking">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://kccarlos.github.io/uploads/xss.png">


<link rel="canonical" href="https://kccarlos.github.io/2022/10/15/Cracking-and-Patching-the-Google-XSS-Game/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://kccarlos.github.io/2022/10/15/Cracking-and-Patching-the-Google-XSS-Game/","path":"2022/10/15/Cracking-and-Patching-the-Google-XSS-Game/","title":"Cracking and Patching the Google XSS Game"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Cracking and Patching the Google XSS Game | KC Blog</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">KC Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Preface-Unable-to-Advance-to-Level-2"><span class="nav-number">1.</span> <span class="nav-text">Preface Unable to Advance to Level 2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XSS-Game-Solutions"><span class="nav-number">2.</span> <span class="nav-text">XSS Game Solutions</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Level-1"><span class="nav-number">2.1.</span> <span class="nav-text">Level 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Level-2"><span class="nav-number">2.2.</span> <span class="nav-text">Level 2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Level-3"><span class="nav-number">2.3.</span> <span class="nav-text">Level 3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Level-4"><span class="nav-number">2.4.</span> <span class="nav-text">Level 4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Level-5"><span class="nav-number">2.5.</span> <span class="nav-text">Level 5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Level-6"><span class="nav-number">2.6.</span> <span class="nav-text">Level 6</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Patching"><span class="nav-number">3.</span> <span class="nav-text">Patching</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#How-to-run-code"><span class="nav-number">3.1.</span> <span class="nav-text">How to run code</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Level-1-1"><span class="nav-number">3.2.</span> <span class="nav-text">Level 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Level-2-1"><span class="nav-number">3.3.</span> <span class="nav-text">Level 2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Level-3-1"><span class="nav-number">3.4.</span> <span class="nav-text">Level 3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Level-4-1"><span class="nav-number">3.5.</span> <span class="nav-text">Level 4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Level-5-1"><span class="nav-number">3.6.</span> <span class="nav-text">Level 5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Level-6-1"><span class="nav-number">3.7.</span> <span class="nav-text">Level 6</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Defense-via-Content-Security-Policy"><span class="nav-number">4.</span> <span class="nav-text">Defense via Content Security Policy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CSP2-0"><span class="nav-number">4.1.</span> <span class="nav-text">CSP2.0</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSP3-0"><span class="nav-number">4.2.</span> <span class="nav-text">CSP3.0</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="kccarlos"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">kccarlos</p>
  <div class="site-description" itemprop="description">Curiosity</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/kccarlos" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kccarlos" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/kccarlos" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kccarlos.github.io/2022/10/15/Cracking-and-Patching-the-Google-XSS-Game/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="kccarlos">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="KC Blog">
      <meta itemprop="description" content="Curiosity">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Cracking and Patching the Google XSS Game | KC Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Cracking and Patching the Google XSS Game
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-10-15 15:25:07" itemprop="dateCreated datePublished" datetime="2022-10-15T15:25:07-04:00">2022-10-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Web-Security/" itemprop="url" rel="index"><span itemprop="name">Web-Security</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><img src="/uploads/xss.png" alt="XSS"></p>
<p>This article discusses</p>
<ul>
<li>Solutions to Google’s <a target="_blank" rel="noopener" href="https://xss-game.appspot.com/">XSS game</a></li>
<li>Re-implementation and patching code in Python Flask, HTML&#x2F;CSS and JavaScript</li>
<li>Some thoughts on using Content Security Policy to defense the code</li>
</ul>
<span id="more"></span>

<p>If you want the code, go to <a target="_blank" rel="noopener" href="https://github.com/kccarlos/googlexssgame">this repo</a>. So let’s dive in!</p>
<h2 id="Preface-Unable-to-Advance-to-Level-2"><a href="#Preface-Unable-to-Advance-to-Level-2" class="headerlink" title="Preface Unable to Advance to Level 2"></a>Preface Unable to Advance to Level 2</h2><p>As of October 2022, the game server has a bug. You may find yourself unable to advance to the next level after cracking the first level puzzle. This is because the game server will send a cookie that has already expired. Then, the the browser will discard it after checking the date.</p>
<p>One solution is to <strong>capture the packet and modify the cookie date before the packet reach the browser</strong>. You can use the packet capturing tools like <a target="_blank" rel="noopener" href="https://portswigger.net/burp/communitydownload">Brup Suite Community Edition</a>. This screenshot shows a server response of one of my submission. Note that the cookie expire date is 22&#x2F;<strong>Jul</strong>&#x2F;2022 12:34:56 GMT (highlighted in orange color).</p>
<p><img src="/uploads/package_capturing.png" alt="packagecapturing"></p>
<p>Then, manually change it to a future date and forward the package. In my case, I changed it to 22&#x2F;Oct&#x2F;2022 12:34:56 GMT. Then, the browser will keep this cookie and attach it to the next request for next level.</p>
<p>Another possible solution is to <strong>change the computer time of the browser to before 2&#x2F;Jul&#x2F;2022 12:34:56 GMT</strong>. In this way, you can avoid the hassle of repetitively modifying the cookie each time you advance to the next level.</p>
<h2 id="XSS-Game-Solutions"><a href="#XSS-Game-Solutions" class="headerlink" title="XSS Game Solutions"></a>XSS Game Solutions</h2><h3 id="Level-1"><a href="#Level-1" class="headerlink" title="Level 1"></a>Level 1</h3><ul>
<li>Vulnerable code is as follows. The website directly take the input from a user and render it as part of the website with no sanitization. As a result, the browser will think the user input is part of the code and execute it.</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">message = <span class="string">&quot;Sorry, no results were found for &lt;b&gt;&quot;</span> + query + <span class="string">&quot;&lt;/b&gt;.&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>How to trigger the vulnerability? input the following string in the search bar and click on search.</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert();<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h3 id="Level-2"><a href="#Level-2" class="headerlink" title="Level 2"></a>Level 2</h3><ul>
<li>Vulnerable code: again the user’s input does not have sanitization and is stored in <code>post[i].message</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">html += <span class="string">&quot;&lt;blockquote&gt;&quot;</span> + posts[i].<span class="property">message</span> + <span class="string">&quot;&lt;/blockquote&quot;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>How to trigger the vulnerability: input the following string in the textfield and click on “Share status!”. The browser will execute this new code and try to find <code>image.gif</code>. It will fail and trigger <code>alert()</code></li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">blockquote</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;image.gif&quot;</span> <span class="attr">onerror</span>=<span class="string">&quot;alert()&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">blockquote</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Level-3"><a href="#Level-3" class="headerlink" title="Level 3"></a>Level 3</h3><ul>
<li>Vulnerable code: this web app will directly take the section that follows <code>#</code> of the URL and pass it into  <code>chooseTab()</code>. <code>chooseTab()</code> will directly embed it into the image tag.</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">chooseTab</span>(<span class="built_in">unescape</span>(self.<span class="property">location</span>.<span class="property">hash</span>.<span class="title function_">substr</span>(<span class="number">1</span>)) || <span class="string">&quot;1&quot;</span>);</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">//in chooseTab</span></span><br><span class="line">html += <span class="string">&quot;&lt;img src=&#x27;/static/level3/cloud&quot;</span> + num + <span class="string">&quot;.jpg&#x27; /&gt;&quot;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>How to trigger the vulnerability: navigate to this URL. Here, the first <code>&#39;</code> will end the image src string. Since the browser cannot find <code>/static/level3/cloud</code>, it will run the function following <code>onerror</code> and trigger <code>alert()</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://xss-game.appspot.com/level3/frame#$(&#x27;&lt;img src=x onerror=alert(1)&gt;&#x27;)</span><br></pre></td></tr></table></figure>

<h3 id="Level-4"><a href="#Level-4" class="headerlink" title="Level 4"></a>Level 4</h3><ul>
<li>Vulnerable code: this web app will take the user input and pass it to <code>startTimer()</code>. <code>startTimer()</code> will directly use this input.</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/static/loading.gif&quot;</span> <span class="attr">onload</span>=<span class="string">&quot;startTimer(&#x27;&#123;&#123; timer &#125;&#125;&#x27;);&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">function startTimer(seconds) &#123;</span><br><span class="line">   seconds = parseInt(seconds) || 3;</span><br><span class="line">... &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>How to trigger the vulnerability. Input the following in the text field. <code>3&#39;)</code> will finish the <code>startTimer()</code> function. Then, it will inject an alert function and get executed.</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3</span><span class="string">&#x27;); alert(&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="Level-5"><a href="#Level-5" class="headerlink" title="Level 5"></a>Level 5</h3><ul>
<li>Vulnerable code: this web app will take the user get request and find out the parameter of <code>next</code>. Then, in HTML it will use it as a hyperlink directly</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">self.<span class="title function_">render_template</span>(<span class="string">&#x27;confirm.html&#x27;</span>, &#123;<span class="string">&#x27;next&#x27;</span>: self.<span class="property">request</span>.<span class="title function_">get</span>(<span class="string">&#x27;next&#x27;</span>, <span class="string">&#x27;welcome&#x27;</span>)&#125;)</span><br><span class="line"></span><br><span class="line">&lt;a href=<span class="string">&quot;&#123;&#123; next &#125;&#125;&quot;</span>&gt;<span class="title class_">Next</span> &gt;&gt;&lt;/a&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>How to trigger the vulnerability: navigate to this URL and click on <code>Next &gt;&gt;</code>. Here we make the parameter of <code>next</code> become <code>javascript:alert()</code>, so the hyperlink <code>href=&quot;javascript:alert()&quot;</code> will make browser to run <code>alert()</code> as javascript code.<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://xss-game.appspot.com/level5/frame/signup?next=javascript:alert();</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Level-6"><a href="#Level-6" class="headerlink" title="Level 6"></a>Level 6</h3><ul>
<li>Vulnerable code: this web app will take the section that follows <code>#</code> of the URL in <code>getGadgetName()</code>. Then attempt to load this URL as javascript.</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">includeGadget</span>(<span class="title function_">getGadgetName</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getGadgetName</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">hash</span>.<span class="title function_">substr</span>(<span class="number">1</span>) || <span class="string">&quot;/static/gadget.js&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// In includeGadget</span></span><br><span class="line"><span class="keyword">var</span> scriptEl = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line">...</span><br><span class="line">scriptEl.<span class="property">src</span> = url;</span><br></pre></td></tr></table></figure>

<ul>
<li>How to trigger the vulnerability: navigate to this URL. Here the <code>//www.google.com/jsapi?callback=alert</code> contains script to trigger <code>alert()</code>. Even though the script added a regular expression to check if the URL contains <code>http</code>, it cannot stop this attack because no <code>http</code> keyword is included. When browser notice that no protocal is given, it will add it automatically. Using <code>hTtp://..</code> is also OK since it’s case insensitive.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://xss-game.appspot.com/level6/frame#//www.google.com/jsapi?callback=alert</span><br></pre></td></tr></table></figure>

<h2 id="Patching"><a href="#Patching" class="headerlink" title="Patching"></a>Patching</h2><h3 id="How-to-run-code"><a href="#How-to-run-code" class="headerlink" title="How to run code"></a>How to run code</h3><ul>
<li>To run the code of level 1, go to <code>l1</code> folder and start the flask server. (For level X, go to <code>lx</code>. For example, level 2 is at <code>src/patch/l2</code>.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd code/patch/l1</span><br><span class="line">python -m flask --app level1 run</span><br></pre></td></tr></table></figure>

<ul>
<li>Then, navigate to <a target="_blank" rel="noopener" href="https://localhost:5000/">https://localhost:5000</a> to view the web app</li>
</ul>
<h3 id="Level-1-1"><a href="#Level-1-1" class="headerlink" title="Level 1"></a>Level 1</h3><p>To ensure that the users’ input is properly escaped, I used the <code>markupSafe</code> library coming along with Flask.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> markupsafe <span class="keyword">import</span> escape</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">query = escape(request.args.get(<span class="string">&#x27;query&#x27;</span>))</span><br><span class="line">message = <span class="string">f&quot;Sorry, no results were found for &lt;b&gt; <span class="subst">&#123;query&#125;</span> &lt;/b&gt;.&quot;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><code>escape()</code> will return a markup object that ensure that any string used along with it will be properly escaped. For example, <code>&lt;script&gt;alert()&lt;/script&gt;</code> will become <code>&amp;lt;script&amp;gt;alert()&amp;lt;/script&amp;gt;</code>. In this way, the user’s input will be treated plaintext instead of HTML-meaningful tags.</p>
<h3 id="Level-2-1"><a href="#Level-2-1" class="headerlink" title="Level 2"></a>Level 2</h3><p>Similar to task 1, the patch is to replace the special characters so that browser will treat it as plaintext. Here, in Line 38 of <code>index.html</code>, I added two <code>replace()</code> methods to replace <code>&lt;</code> and <code>&gt;</code> into <code>&amp;lt;</code> and <code>&amp;gt;</code> respectively.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">encoded = posts[i].<span class="property">message</span>.<span class="title function_">replace</span>(<span class="regexp">/&lt;/g</span>, <span class="string">&quot;&amp;lt;&quot;</span>).<span class="title function_">replace</span>(<span class="regexp">/&gt;/g</span>, <span class="string">&quot;&amp;gt;&quot;</span>);</span><br><span class="line">html += <span class="string">&quot;&lt;blockquote&gt;&quot;</span> + encoded + <span class="string">&quot;&lt;/blockquote&quot;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Level-3-1"><a href="#Level-3-1" class="headerlink" title="Level 3"></a>Level 3</h3><p>To prevent URL injection, my patch is to parse the user’s input URL first. If a number cannot be extracted (potentially having some unexpected characters following the number), then the user will be redirected to tab 1.</p>
<p>Therefore, in Line 38 of <code>index.html</code>, I added a <code>parseInt()</code> function to process the user input as number. Then, a if condition will decide if the number is an expected one.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">num = <span class="built_in">unescape</span>(<span class="built_in">parseInt</span>(self.<span class="property">location</span>.<span class="property">hash</span>.<span class="title function_">substr</span>(<span class="number">1</span>)))</span><br><span class="line"><span class="keyword">if</span> ((num == <span class="number">1</span>) || (num == <span class="number">2</span>) || (num == <span class="number">3</span>)) &#123;<span class="title function_">chooseTab</span>(num)&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;<span class="title function_">chooseTab</span>(<span class="number">1</span>)&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Level-4-1"><a href="#Level-4-1" class="headerlink" title="Level 4"></a>Level 4</h3><p>My patch is to parse the user’s input URL first by trying to cast it into an integer. If an integer cannot be obtained (potentially having some unexpected characters following the number), then the user will be redirected to front page to ask for another input.</p>
<p>Therefore, in Line 13 of <code>level4.py</code>, I added a <code>int()</code> function to process the user input into integer. The <code>try</code> statement will catch any error in the integer casting. Only integer will be proceeded with next page.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    timer = <span class="built_in">int</span>(request.args.get(<span class="string">&#x27;timer&#x27;</span>))</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"><span class="keyword">return</span> render_template(<span class="string">&#x27;timer.html&#x27;</span>, timer=timer)</span><br></pre></td></tr></table></figure>

<h3 id="Level-5-1"><a href="#Level-5-1" class="headerlink" title="Level 5"></a>Level 5</h3><p>My patch is to check the user’s input URL against all available routes. If it cannot match any of the routes, the client will be redirect to main page.</p>
<p>Therefore, in both Line 18 and Line 25 of <code>level5.py</code>, I added an <code>if</code> clause to check user’s URL. So the value of <code>next</code> will be confined to avoid exploit.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">availableRoutes = [<span class="string">&#x27;signup&#x27;</span>, <span class="string">&#x27;confirm&#x27;</span>, <span class="string">&#x27;welcome&#x27;</span>]</span><br><span class="line">...</span><br><span class="line"><span class="built_in">next</span> = request.args.get(<span class="string">&#x27;next&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">next</span> <span class="keyword">in</span> availableRoutes:</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;signup.html&#x27;</span>, <span class="built_in">next</span>=<span class="built_in">next</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;/welcome&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Level-6-1"><a href="#Level-6-1" class="headerlink" title="Level 6"></a>Level 6</h3><p>My patch is to use a regular expression to enforce that only files inside static folder are acceptable.</p>
<p>In Line 22 <code>index.html</code>, the original code has a regular expression that looks for link starting with http. The new regular expression ensures that only urls like <code>#/static/*</code> is acceptable.</p>
<p>For example:</p>
<ul>
<li><code>http://localhost:5000/#/static/gadget.js</code> will be accepted.</li>
<li><code>http://localhost:5000/#//www.google.com/jsapi?callback=alert</code> will be rejected.</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> scriptEl = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line"><span class="comment">// Reject the url if it&#x27;s not under the static folder</span></span><br><span class="line"><span class="keyword">if</span> (!url.<span class="title function_">match</span>(<span class="regexp">/^\/static\//</span>)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;log&quot;</span>)) &#123;</span><br><span class="line">    <span class="title function_">setInnerText</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;log&quot;</span>),</span><br><span class="line">            <span class="string">&quot;Sorry, cannot load a URL not from /static/.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Defense-via-Content-Security-Policy"><a href="#Defense-via-Content-Security-Policy" class="headerlink" title="Defense via Content Security Policy"></a>Defense via Content Security Policy</h2><h3 id="CSP2-0"><a href="#CSP2-0" class="headerlink" title="CSP2.0"></a>CSP2.0</h3><ul>
<li>Example code: <code>default-src &#39;none&#39;; script-src &#39;self&#39;; connect-src &#39;self&#39;; img-src &#39;self&#39;; style-src &#39;self&#39;; base-uri &#39;self&#39;; form-action &#39;self&#39;</code></li>
<li>Patched code using CSP2.0: <code>src/csp2/</code> from <code>l1</code> to <code>l6</code></li>
</ul>
<h3 id="CSP3-0"><a href="#CSP3-0" class="headerlink" title="CSP3.0"></a>CSP3.0</h3><ul>
<li>Example code: <code>script-src &#39;self&#39; &#39;nonce-N42HzqVZYhG0RWr8CwB8hQ==&#39; ;&#39;</code></li>
<li>Patched code is available in <code>./code/csp3/</code> from <code>l1</code> to <code>l6</code>. Inline code is refactored and external files are downloaded to comply with the CPS requirements</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>kccarlos
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="https://kccarlos.github.io/2022/10/15/Cracking-and-Patching-the-Google-XSS-Game/" title="Cracking and Patching the Google XSS Game">https://kccarlos.github.io/2022/10/15/Cracking-and-Patching-the-Google-XSS-Game/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/XSS/" rel="tag"># XSS</a>
              <a href="/tags/Hacking/" rel="tag"># Hacking</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/06/03/How-to-install-and-configure-Samba-on-Ubuntu-14-04/" rel="prev" title="How to Install and Configure Samba on Ubuntu 14.04">
                  <i class="fa fa-chevron-left"></i> How to Install and Configure Samba on Ubuntu 14.04
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/11/06/Prototype-Pollution-Example-Exploit-and-Patching/" rel="next" title="Prototype Pollution - an Exploit and Patching Example">
                  Prototype Pollution - an Exploit and Patching Example <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kccarlos</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  




  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://kccarlos.github.io/2022/10/15/Cracking-and-Patching-the-Google-XSS-Game/"}</script>
  <script src="/js/third-party/quicklink.js"></script>

</body>
</html>
